using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using TwitchLib.Api;
using TwitchLib.Api.Helix.Models.Users;
using TwitchLib.Api.Helix.Models.Streams;
using TwitchLib.Api.Helix.Models.Channels;
using TwitchLib.Api.Helix.Models.Chat;
using PerAspera.Core.IL2CPP;
using PerAspera.SDK.TwitchIntegration.Core;

namespace PerAspera.SDK.TwitchIntegration.Api
{
    /// <summary>
    /// TwitchLib.Api Helix integration for modern Twitch API features
    /// Provides channel info, user management, and EventSub-ready functionality
    /// </summary>
    public class TwitchApiManager
    {
        private static readonly LogAspera Log = LogAspera.Create("TwitchApiManager");
        
        private readonly TwitchAPI _api;
        private readonly ILogger<TwitchApiManager> _logger;
        private readonly TwitchIntegrationConfig _config;
        
        private string? _broadcasterId;
        private string? _moderatorId;
        
        /// <summary>
        /// Initialize TwitchLib API manager with OAuth credentials
        /// </summary>
        /// <param name="clientId">Twitch application client ID</param>
        /// <param name="accessToken">User access token with appropriate scopes</param>
        /// <param name="logger">Logger instance</param>
        /// <param name="config">Twitch integration configuration</param>
        public TwitchApiManager(
            string clientId,
            string accessToken,
            ILogger<TwitchApiManager> logger,
            TwitchIntegrationConfig config)
        {
            if (string.IsNullOrEmpty(clientId))
                throw new ArgumentException("Client ID cannot be null or empty", nameof(clientId));
            if (string.IsNullOrEmpty(accessToken))
                throw new ArgumentException("Access token cannot be null or empty", nameof(accessToken));
            
            _logger = logger ?? throw new ArgumentNullException(nameof(logger));
            _config = config ?? throw new ArgumentNullException(nameof(config));
            
            // Initialize TwitchLib API with credentials
            _api = new TwitchAPI();
            _api.Settings.ClientId = clientId;
            _api.Settings.AccessToken = accessToken;
            
            Log.Info($"TwitchLib API initialized with client ID: {clientId[..8]}...");\n        }\n        \n        /// <summary>\n        /// Initialize broadcaster and moderator IDs for API operations\n        /// </summary>\n        /// <param name=\"broadcasterUsername\">Username of the broadcaster</param>\n        /// <param name=\"moderatorUsername\">Username of the moderator (bot)</param>\n        public async Task InitializeAsync(string broadcasterUsername, string? moderatorUsername = null)\n        {\n            try\n            {\n                // Get broadcaster user info\n                var broadcasterUsers = await _api.Helix.Users.GetUsersAsync(logins: new[] { broadcasterUsername });\n                var broadcasterUser = broadcasterUsers?.Users?.FirstOrDefault();\n                \n                if (broadcasterUser == null)\n                {\n                    throw new InvalidOperationException($\"Broadcaster user not found: {broadcasterUsername}\");\n                }\n                \n                _broadcasterId = broadcasterUser.Id;\n                \n                // Get moderator user info if specified\n                if (!string.IsNullOrEmpty(moderatorUsername))\n                {\n                    var moderatorUsers = await _api.Helix.Users.GetUsersAsync(logins: new[] { moderatorUsername });\n                    var moderatorUser = moderatorUsers?.Users?.FirstOrDefault();\n                    _moderatorId = moderatorUser?.Id;\n                }\n                \n                Log.Info($\"API initialized - Broadcaster: {broadcasterUsername} ({_broadcasterId}), Moderator: {moderatorUsername ?? \"None\"}\");\n                _logger.LogInformation($\"TwitchLib API ready for broadcaster: {broadcasterUsername}\");\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Failed to initialize TwitchLib API: {ex.Message}\", ex);\n                throw;\n            }\n        }\n        \n        #region Channel & Stream Information\n        \n        /// <summary>\n        /// Get current stream information (viewer count, game, title)\n        /// </summary>\n        public async Task<StreamInfo?> GetStreamInfoAsync()\n        {\n            if (string.IsNullOrEmpty(_broadcasterId))\n            {\n                Log.Warning(\"Cannot get stream info - broadcaster ID not initialized\");\n                return null;\n            }\n            \n            try\n            {\n                var streams = await _api.Helix.Streams.GetStreamsAsync(userIds: new[] { _broadcasterId });\n                var stream = streams?.Streams?.FirstOrDefault();\n                \n                if (stream == null)\n                {\n                    return new StreamInfo\n                    {\n                        IsLive = false,\n                        ViewerCount = 0,\n                        GameName = \"Offline\",\n                        Title = \"Stream Offline\",\n                        StartedAt = null\n                    };\n                }\n                \n                return new StreamInfo\n                {\n                    IsLive = true,\n                    ViewerCount = stream.ViewerCount,\n                    GameName = stream.GameName ?? \"Unknown\",\n                    Title = stream.Title ?? \"No Title\",\n                    StartedAt = stream.StartedAt,\n                    Language = stream.Language,\n                    ThumbnailUrl = stream.ThumbnailUrl\n                };\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Failed to get stream info: {ex.Message}\", ex);\n                return null;\n            }\n        }\n        \n        /// <summary>\n        /// Get channel information (game category, title, etc.)\n        /// </summary>\n        public async Task<ChannelInformation?> GetChannelInfoAsync()\n        {\n            if (string.IsNullOrEmpty(_broadcasterId))\n            {\n                Log.Warning(\"Cannot get channel info - broadcaster ID not initialized\");\n                return null;\n            }\n            \n            try\n            {\n                var channels = await _api.Helix.Channels.GetChannelInformationAsync(_broadcasterId);\n                return channels?.Data?.FirstOrDefault();\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Failed to get channel info: {ex.Message}\", ex);\n                return null;\n            }\n        }\n        \n        /// <summary>\n        /// Update channel information (requires appropriate scopes)\n        /// </summary>\n        public async Task<bool> UpdateChannelInfoAsync(string? gameId = null, string? title = null)\n        {\n            if (string.IsNullOrEmpty(_broadcasterId))\n            {\n                Log.Warning(\"Cannot update channel info - broadcaster ID not initialized\");\n                return false;\n            }\n            \n            try\n            {\n                var request = new ModifyChannelInformationRequest();\n                \n                if (!string.IsNullOrEmpty(gameId))\n                    request.GameId = gameId;\n                    \n                if (!string.IsNullOrEmpty(title))\n                    request.Title = title;\n                \n                await _api.Helix.Channels.ModifyChannelInformationAsync(_broadcasterId, request);\n                \n                Log.Info($\"Channel info updated - Game: {gameId}, Title: {title}\");\n                return true;\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Failed to update channel info: {ex.Message}\", ex);\n                return false;\n            }\n        }\n        \n        #endregion\n        \n        #region User Management\n        \n        /// <summary>\n        /// Get user information by username or ID\n        /// </summary>\n        public async Task<User?> GetUserAsync(string usernameOrId)\n        {\n            try\n            {\n                GetUsersResponse? users;\n                \n                // Try as username first, then as ID\n                if (usernameOrId.All(char.IsDigit))\n                {\n                    users = await _api.Helix.Users.GetUsersAsync(ids: new[] { usernameOrId });\n                }\n                else\n                {\n                    users = await _api.Helix.Users.GetUsersAsync(logins: new[] { usernameOrId });\n                }\n                \n                return users?.Users?.FirstOrDefault();\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Failed to get user info for {usernameOrId}: {ex.Message}\", ex);\n                return null;\n            }\n        }\n        \n        /// <summary>\n        /// Check if user is a moderator in the channel\n        /// </summary>\n        public async Task<bool> IsModeratorAsync(string username)\n        {\n            if (string.IsNullOrEmpty(_broadcasterId))\n            {\n                return false;\n            }\n            \n            try\n            {\n                var user = await GetUserAsync(username);\n                if (user == null) return false;\n                \n                var moderators = await _api.Helix.Moderation.GetModeratorsAsync(_broadcasterId);\n                return moderators?.Data?.Any(m => m.UserId == user.Id) == true;\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Failed to check moderator status for {username}: {ex.Message}\", ex);\n                return false;\n            }\n        }\n        \n        /// <summary>\n        /// Check if user is a VIP in the channel\n        /// </summary>\n        public async Task<bool> IsVipAsync(string username)\n        {\n            if (string.IsNullOrEmpty(_broadcasterId))\n            {\n                return false;\n            }\n            \n            try\n            {\n                var user = await GetUserAsync(username);\n                if (user == null) return false;\n                \n                var vips = await _api.Helix.Channels.GetVIPsAsync(_broadcasterId);\n                return vips?.Data?.Any(v => v.UserId == user.Id) == true;\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Failed to check VIP status for {username}: {ex.Message}\", ex);\n                return false;\n            }\n        }\n        \n        #endregion\n        \n        #region Chat Management (EventSub Ready)\n        \n        /// <summary>\n        /// Send chat message via Helix API (EventSub compatible)\n        /// Alternative to IRC for modern integration\n        /// </summary>\n        public async Task<bool> SendChatMessageAsync(string message)\n        {\n            if (string.IsNullOrEmpty(_broadcasterId) || string.IsNullOrEmpty(_moderatorId))\n            {\n                Log.Warning(\"Cannot send chat message via API - broadcaster or moderator ID not initialized\");\n                return false;\n            }\n            \n            try\n            {\n                await _api.Helix.Chat.SendChatMessageAsync(\n                    broadcasterId: _broadcasterId,\n                    senderId: _moderatorId,\n                    message: message);\n                \n                Log.Debug($\"Chat message sent via API: {message}\");\n                return true;\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Failed to send chat message via API: {ex.Message}\", ex);\n                return false;\n            }\n        }\n        \n        /// <summary>\n        /// Get chat settings for the channel\n        /// </summary>\n        public async Task<ChatSettings?> GetChatSettingsAsync()\n        {\n            if (string.IsNullOrEmpty(_broadcasterId))\n            {\n                return null;\n            }\n            \n            try\n            {\n                var settings = await _api.Helix.Chat.GetChatSettingsAsync(\n                    broadcasterId: _broadcasterId,\n                    moderatorId: _moderatorId);\n                \n                return settings?.Data?.FirstOrDefault();\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Failed to get chat settings: {ex.Message}\", ex);\n                return null;\n            }\n        }\n        \n        #endregion\n        \n        #region Analytics & Monitoring\n        \n        /// <summary>\n        /// Get follower count for analytics\n        /// </summary>\n        public async Task<int> GetFollowerCountAsync()\n        {\n            if (string.IsNullOrEmpty(_broadcasterId))\n            {\n                return 0;\n            }\n            \n            try\n            {\n                var followers = await _api.Helix.Channels.GetChannelFollowersAsync(\n                    broadcasterId: _broadcasterId);\n                \n                return followers?.Total ?? 0;\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Failed to get follower count: {ex.Message}\", ex);\n                return 0;\n            }\n        }\n        \n        /// <summary>\n        /// Create analytics summary for Per Aspera integration\n        /// </summary>\n        public async Task<TwitchAnalyticsSummary> GetAnalyticsSummaryAsync()\n        {\n            var summary = new TwitchAnalyticsSummary\n            {\n                Timestamp = DateTime.UtcNow\n            };\n            \n            try\n            {\n                // Get stream info\n                var streamInfo = await GetStreamInfoAsync();\n                summary.IsLive = streamInfo?.IsLive ?? false;\n                summary.ViewerCount = streamInfo?.ViewerCount ?? 0;\n                summary.GameName = streamInfo?.GameName ?? \"Unknown\";\n                \n                // Get follower count\n                summary.FollowerCount = await GetFollowerCountAsync();\n                \n                // Get channel info\n                var channelInfo = await GetChannelInfoAsync();\n                summary.ChannelTitle = channelInfo?.Title ?? \"Unknown\";\n                \n                Log.Debug($\"Analytics summary: Live={summary.IsLive}, Viewers={summary.ViewerCount}, Followers={summary.FollowerCount}\");\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Failed to create analytics summary: {ex.Message}\", ex);\n            }\n            \n            return summary;\n        }\n        \n        #endregion\n        \n        /// <summary>\n        /// Check if API is properly initialized and authenticated\n        /// </summary>\n        public bool IsInitialized => !string.IsNullOrEmpty(_broadcasterId);\n        \n        /// <summary>\n        /// Get broadcaster ID\n        /// </summary>\n        public string? BroadcasterId => _broadcasterId;\n        \n        /// <summary>\n        /// Get moderator ID\n        /// </summary>\n        public string? ModeratorId => _moderatorId;\n    }\n    \n    /// <summary>\n    /// Stream information model for Per Aspera integration\n    /// </summary>\n    public class StreamInfo\n    {\n        public bool IsLive { get; set; }\n        public int ViewerCount { get; set; }\n        public string GameName { get; set; } = string.Empty;\n        public string Title { get; set; } = string.Empty;\n        public DateTime? StartedAt { get; set; }\n        public string? Language { get; set; }\n        public string? ThumbnailUrl { get; set; }\n    }\n    \n    /// <summary>\n    /// Analytics summary for dashboard and Per Aspera integration\n    /// </summary>\n    public class TwitchAnalyticsSummary\n    {\n        public DateTime Timestamp { get; set; }\n        public bool IsLive { get; set; }\n        public int ViewerCount { get; set; }\n        public int FollowerCount { get; set; }\n        public string GameName { get; set; } = string.Empty;\n        public string ChannelTitle { get; set; } = string.Empty;\n    }\n}