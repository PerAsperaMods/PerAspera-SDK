using System;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using TwitchLib.PubSub;
using TwitchLib.PubSub.Events;
using PerAspera.Core.IL2CPP;
using PerAspera.GameAPI.Events;
using PerAspera.SDK.TwitchIntegration.Core;
using PerAspera.SDK.TwitchIntegration.Events;

namespace PerAspera.SDK.TwitchIntegration.PubSub
{
    /// <summary>
    /// TwitchLib.PubSub integration for real-time stream events
    /// Provides follows, bits, subscriptions, and channel points integration with Per Aspera
    /// </summary>
    public class TwitchPubSubManager : IDisposable
    {
        private static readonly LogAspera Log = LogAspera.Create("TwitchPubSubManager");
        
        private readonly TwitchPubSub _pubsub;
        private readonly ILogger<TwitchPubSubManager> _logger;
        private readonly TwitchIntegrationConfig _config;
        private readonly ITwitchGameEventBridge _gameEventBridge;
        
        private string? _channelId;
        private bool _isInitialized = false;
        private bool _isConnected = false;
        
        /// <summary>
        /// Initialize PubSub manager with game event integration
        /// </summary>
        /// <param name="logger">Logger instance</param>
        /// <param name="config">Twitch integration configuration</param>
        /// <param name="gameEventBridge">Bridge for Per Aspera game events</param>\n        public TwitchPubSubManager(\n            ILogger<TwitchPubSubManager> logger,\n            TwitchIntegrationConfig config,\n            ITwitchGameEventBridge gameEventBridge)\n        {\n            _logger = logger ?? throw new ArgumentNullException(nameof(logger));\n            _config = config ?? throw new ArgumentNullException(nameof(config));\n            _gameEventBridge = gameEventBridge ?? throw new ArgumentNullException(nameof(gameEventBridge));\n            \n            // Initialize TwitchLib PubSub\n            _pubsub = new TwitchPubSub();\n            \n            // Subscribe to PubSub events\n            _pubsub.OnPubSubServiceConnected += OnPubSubConnectedAsync;\n            _pubsub.OnPubSubServiceClosed += OnPubSubClosedAsync;\n            _pubsub.OnPubSubServiceError += OnPubSubErrorAsync;\n            \n            // Real-time stream events\n            _pubsub.OnFollowing += OnFollowingAsync;\n            _pubsub.OnBitsReceived += OnBitsReceivedAsync;\n            _pubsub.OnChannelSubscription += OnSubscriptionAsync;\n            _pubsub.OnChannelPointsRewardRedeemed += OnChannelPointsRedeemedAsync;\n            \n            Log.Info(\"TwitchPubSubManager initialized\");\n        }\n        \n        /// <summary>\n        /// Initialize PubSub connection and subscriptions\n        /// </summary>\n        /// <param name=\"channelId\">Twitch channel ID (numeric)</param>\n        /// <param name=\"accessToken\">User access token with appropriate scopes</param>\n        public async Task InitializeAsync(string channelId, string accessToken)\n        {\n            if (string.IsNullOrEmpty(channelId))\n                throw new ArgumentException(\"Channel ID cannot be null or empty\", nameof(channelId));\n            if (string.IsNullOrEmpty(accessToken))\n                throw new ArgumentException(\"Access token cannot be null or empty\", nameof(accessToken));\n            \n            try\n            {\n                _channelId = channelId;\n                \n                // Connect to PubSub service\n                _pubsub.Connect();\n                \n                // Wait briefly for connection\n                await Task.Delay(1000);\n                \n                // Subscribe to events based on configuration\n                if (_config.EnableFollowEvents)\n                {\n                    _pubsub.ListenToFollows(channelId);\n                    Log.Info(\"Subscribed to follow events\");\n                }\n                \n                if (_config.EnableBitsEvents)\n                {\n                    _pubsub.ListenToBitsEvents(channelId);\n                    Log.Info(\"Subscribed to bits events\");\n                }\n                \n                if (_config.EnableSubscriptionEvents)\n                {\n                    _pubsub.ListenToSubscriptions(channelId);\n                    Log.Info(\"Subscribed to subscription events\");\n                }\n                \n                if (_config.EnableChannelPointsEvents)\n                {\n                    _pubsub.ListenToChannelPoints(channelId);\n                    Log.Info(\"Subscribed to channel points events\");\n                }\n                \n                // Send topics with authentication\n                _pubsub.SendTopics(accessToken);\n                \n                _isInitialized = true;\n                Log.Info($\"PubSub initialized for channel: {channelId}\");\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Failed to initialize PubSub: {ex.Message}\", ex);\n                throw;\n            }\n        }\n        \n        #region PubSub Connection Events\n        \n        private async Task OnPubSubConnectedAsync(object? sender, EventArgs e)\n        {\n            _isConnected = true;\n            _logger.LogInformation(\"Connected to Twitch PubSub\");\n            Log.Info(\"Successfully connected to Twitch PubSub service\");\n            \n            await Task.CompletedTask;\n        }\n        \n        private async Task OnPubSubClosedAsync(object? sender, EventArgs e)\n        {\n            _isConnected = false;\n            _logger.LogWarning(\"Disconnected from Twitch PubSub\");\n            Log.Warning(\"Lost connection to Twitch PubSub service\");\n            \n            // TODO: Implement auto-reconnection logic\n            await Task.CompletedTask;\n        }\n        \n        private async Task OnPubSubErrorAsync(object? sender, OnPubSubServiceErrorArgs e)\n        {\n            _logger.LogError($\"PubSub service error: {e.Exception?.Message}\");\n            Log.Error($\"PubSub service error: {e.Exception?.Message}\", e.Exception);\n            \n            await Task.CompletedTask;\n        }\n        \n        #endregion\n        \n        #region Stream Event Handlers\n        \n        /// <summary>\n        /// Handle new follower events\n        /// </summary>\n        private async Task OnFollowingAsync(object? sender, OnFollowingArgs e)\n        {\n            try\n            {\n                var followerName = e.Username;\n                var displayName = e.DisplayName ?? followerName;\n                \n                _logger.LogInformation($\"New follower: {displayName} ({followerName})\");\n                Log.Info($\"New follower detected: {displayName}\");\n                \n                // Create follow event for Per Aspera integration\n                var followEvent = new TwitchFollowEvent\n                {\n                    FollowerName = followerName,\n                    DisplayName = displayName,\n                    Timestamp = DateTime.UtcNow,\n                    ChannelId = _channelId!\n                };\n                \n                // Trigger game reaction through event bridge\n                await _gameEventBridge.ProcessFollowEventAsync(followEvent);\n                \n                // Publish to Per Aspera event system\n                EventsAutoStartPlugin.EnhancedEvents.Publish(followEvent);\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Error processing follow event: {ex.Message}\", ex);\n            }\n        }\n        \n        /// <summary>\n        /// Handle bits/cheer events\n        /// </summary>\n        private async Task OnBitsReceivedAsync(object? sender, OnBitsReceivedArgs e)\n        {\n            try\n            {\n                var username = e.Username;\n                var displayName = e.DisplayName ?? username;\n                var bitsUsed = e.BitsUsed;\n                var chatMessage = e.ChatMessage;\n                \n                _logger.LogInformation($\"{displayName} cheered {bitsUsed} bits: {chatMessage}\");\n                Log.Info($\"Bits received: {displayName} cheered {bitsUsed} bits\");\n                \n                // Create bits event for Per Aspera integration\n                var bitsEvent = new TwitchBitsEvent\n                {\n                    Username = username,\n                    DisplayName = displayName,\n                    BitsAmount = bitsUsed,\n                    Message = chatMessage,\n                    Timestamp = DateTime.UtcNow,\n                    ChannelId = _channelId!,\n                    EffectMultiplier = CalculateBitsEffectMultiplier(bitsUsed)\n                };\n                \n                // Trigger game reaction through event bridge\n                await _gameEventBridge.ProcessBitsEventAsync(bitsEvent);\n                \n                // Publish to Per Aspera event system\n                EventsAutoStartPlugin.EnhancedEvents.Publish(bitsEvent);\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Error processing bits event: {ex.Message}\", ex);\n            }\n        }\n        \n        /// <summary>\n        /// Handle subscription events\n        /// </summary>\n        private async Task OnSubscriptionAsync(object? sender, OnChannelSubscriptionArgs e)\n        {\n            try\n            {\n                var subscriber = e.Subscription;\n                var username = subscriber.Username;\n                var displayName = subscriber.DisplayName ?? username;\n                var subscriptionPlan = subscriber.SubscriptionPlan.ToString();\n                var isGift = subscriber.IsGift;\n                \n                _logger.LogInformation($\"New subscription: {displayName} ({subscriptionPlan}, Gift: {isGift})\");\n                Log.Info($\"Subscription detected: {displayName} - {subscriptionPlan}\");\n                \n                // Create subscription event for Per Aspera integration\n                var subEvent = new TwitchSubscriptionEvent\n                {\n                    Username = username,\n                    DisplayName = displayName,\n                    SubscriptionPlan = subscriptionPlan,\n                    IsGift = isGift,\n                    Timestamp = DateTime.UtcNow,\n                    ChannelId = _channelId!,\n                    PermanentBonus = CalculateSubscriptionBonus(subscriptionPlan)\n                };\n                \n                // Trigger game reaction through event bridge\n                await _gameEventBridge.ProcessSubscriptionEventAsync(subEvent);\n                \n                // Publish to Per Aspera event system\n                EventsAutoStartPlugin.EnhancedEvents.Publish(subEvent);\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Error processing subscription event: {ex.Message}\", ex);\n            }\n        }\n        \n        /// <summary>\n        /// Handle channel points redemption events\n        /// </summary>\n        private async Task OnChannelPointsRedeemedAsync(object? sender, OnChannelPointsRewardRedeemedArgs e)\n        {\n            try\n            {\n                var redemption = e.RewardRedeemed;\n                var username = redemption.Redemption.User.Login;\n                var displayName = redemption.Redemption.User.DisplayName ?? username;\n                var rewardTitle = redemption.Redemption.Reward.Title;\n                var rewardCost = redemption.Redemption.Reward.Cost;\n                var userInput = redemption.Redemption.UserInput;\n                \n                _logger.LogInformation($\"Channel points redeemed: {displayName} redeemed '{rewardTitle}' ({rewardCost} points)\");\n                Log.Info($\"Channel points: {displayName} redeemed {rewardTitle}\");\n                \n                // Create channel points event for Per Aspera integration\n                var pointsEvent = new TwitchChannelPointsEvent\n                {\n                    Username = username,\n                    DisplayName = displayName,\n                    RewardTitle = rewardTitle,\n                    RewardCost = rewardCost,\n                    UserInput = userInput,\n                    Timestamp = DateTime.UtcNow,\n                    ChannelId = _channelId!\n                };\n                \n                // Trigger game reaction through event bridge\n                await _gameEventBridge.ProcessChannelPointsEventAsync(pointsEvent);\n                \n                // Publish to Per Aspera event system\n                EventsAutoStartPlugin.EnhancedEvents.Publish(pointsEvent);\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Error processing channel points event: {ex.Message}\", ex);\n            }\n        }\n        \n        #endregion\n        \n        #region Effect Calculation Helpers\n        \n        /// <summary>\n        /// Calculate effect multiplier based on bits amount\n        /// </summary>\n        private float CalculateBitsEffectMultiplier(int bits)\n        {\n            return _config.BitsEffectMultiplier switch\n            {\n                \"linear\" => Math.Min(bits / 100.0f, 5.0f), // Linear scaling, capped at 5x\n                \"logarithmic\" => Math.Min((float)Math.Log10(bits + 1), 3.0f), // Log scaling, capped at 3x\n                \"threshold\" => bits >= 1000 ? 5.0f : bits >= 500 ? 3.0f : bits >= 100 ? 2.0f : 1.0f, // Threshold-based\n                _ => Math.Min(bits / 100.0f, 2.0f) // Default: linear with 2x cap\n            };\n        }\n        \n        /// <summary>\n        /// Calculate permanent bonus for subscription\n        /// </summary>\n        private float CalculateSubscriptionBonus(string subscriptionPlan)\n        {\n            return subscriptionPlan.ToLower() switch\n            {\n                \"tier 3\" or \"prime\" => 0.5f, // 50% permanent bonus\n                \"tier 2\" => 0.3f, // 30% permanent bonus\n                \"tier 1\" or \"1000\" => 0.2f, // 20% permanent bonus\n                _ => 0.1f // 10% default bonus\n            };\n        }\n        \n        #endregion\n        \n        /// <summary>\n        /// Get current connection status\n        /// </summary>\n        public bool IsConnected => _isConnected;\n        \n        /// <summary>\n        /// Check if PubSub is properly initialized\n        /// </summary>\n        public bool IsInitialized => _isInitialized;\n        \n        /// <summary>\n        /// Get current channel ID\n        /// </summary>\n        public string? ChannelId => _channelId;\n        \n        /// <summary>\n        /// Graceful shutdown of PubSub connection\n        /// </summary>\n        public async Task DisconnectAsync()\n        {\n            try\n            {\n                if (_pubsub != null && _isConnected)\n                {\n                    _pubsub.Disconnect();\n                    _isConnected = false;\n                }\n                \n                Log.Info(\"PubSub disconnected gracefully\");\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Error during PubSub disconnect: {ex.Message}\", ex);\n            }\n            \n            await Task.CompletedTask;\n        }\n        \n        /// <summary>\n        /// IDisposable implementation\n        /// </summary>\n        public void Dispose()\n        {\n            try\n            {\n                _pubsub?.Disconnect();\n                _pubsub?.Dispose();\n                \n                Log.Info(\"TwitchPubSubManager disposed\");\n            }\n            catch (Exception ex)\n            {\n                Log.Error($\"Error during TwitchPubSubManager disposal: {ex.Message}\", ex);\n            }\n        }\n    }\n}