name: Mod Development Assistant

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  mod-assistant:
    if: contains(github.event.issue.labels.*.name, 'mod-help') || contains(github.event.comment.body, '@mod-assistant')
    runs-on: ubuntu-latest
    
    steps:
    - name: Analyze issue for mod help
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.payload.issue;
          const comment = context.payload.comment;
          
          // Patterns pour identifier les types de problÃ¨mes
          const patterns = {
            'compilation-error': /error|compilation|build|compile/i,
            'bepinex-setup': /bepinex|installation|setup|install/i,
            'harmony-patch': /harmony|patch|postfix|prefix/i,
            'il2cpp-issue': /il2cpp|interop|assembly/i,
            'yaml-modding': /yaml|building|resource|technology/i,
            'debugging': /debug|log|crash|exception/i
          };
          
          const body = issue ? issue.body : comment.body;
          const title = issue ? issue.title : '';
          const content = (title + ' ' + body).toLowerCase();
          
          let detectedType = 'general';
          let suggestions = [];
          
          for (const [type, pattern] of Object.entries(patterns)) {
            if (pattern.test(content)) {
              detectedType = type;
              break;
            }
          }
          
          // GÃ©nÃ©rer des suggestions basÃ©es sur le type dÃ©tectÃ©
          switch(detectedType) {
            case 'compilation-error':
              suggestions = [
                'ðŸ”§ VÃ©rifiez que vous utilisez .NET 6.0 ou .NET Framework 4.7.2',
                'ðŸ“¦ Assurez-vous que les rÃ©fÃ©rences BepInEx sont correctement configurÃ©es',
                'ðŸ“ VÃ©rifiez que GameLibs.props pointe vers le bon dossier',
                'ðŸ” Consultez le fichier [working/PerAsperaMod.csproj](working/PerAsperaMod.csproj) pour un exemple'
              ];
              break;
              
            case 'bepinex-setup':
              suggestions = [
                'ðŸ“¥ TÃ©lÃ©chargez BepInEx 6.x IL2CPP depuis https://github.com/BepInEx/BepInEx/releases',
                'ðŸ“‚ Placez les DLLs dans `BepInEx/plugins/`',
                'âš™ï¸ Configurez `doorstop_config.ini` pour pointer vers BepInEx',
                'ðŸ“‹ Consultez les [instructions d\'installation](Documentation/) pour plus de dÃ©tails'
              ];
              break;
              
            case 'harmony-patch':
              suggestions = [
                'ðŸŽ¯ Utilisez `[HarmonyPatch]` pour cibler la mÃ©thode',
                'âš¡ PrÃ©fÃ©rez `Postfix` pour modifier les valeurs de retour',
                'ðŸ”„ Utilisez `Prefix` pour empÃªcher l\'exÃ©cution originale',
                'ðŸ“š Consultez la [documentation Harmony](https://harmony.pardeike.net/)'
              ];
              break;
              
            case 'il2cpp-issue':
              suggestions = [
                'ðŸ”— VÃ©rifiez que les assemblies interop sont gÃ©nÃ©rÃ©es dans `BepInEx/interop/`',
                'ðŸ—ï¸ Utilisez `BasePlugin` au lieu de `BaseUnityPlugin`',
                'âš ï¸ Attention aux types `Il2Cpp*` pour les objets Unity',
                'ðŸ” VÃ©rifiez les logs BepInEx pour les erreurs d\'interop'
              ];
              break;
              
            case 'yaml-modding':
              suggestions = [
                'ðŸ“„ Modifiez les fichiers dans `datamodel/` avec prÃ©caution',
                'ðŸ”— Respectez la syntaxe `!resource resource_name`',
                'ðŸ’¾ Testez la compatibilitÃ© des sauvegardes',
                'ðŸ“– Consultez les [exemples YAML](Documentation/Hardpoint/)'
              ];
              break;
              
            case 'debugging':
              suggestions = [
                'ðŸ“Š VÃ©rifiez `BepInEx/LogOutput.log` pour les erreurs',
                'âš™ï¸ Activez les logs dÃ©taillÃ©s dans `BepInEx.cfg`',
                'ðŸ” Utilisez `ManualLogSource` pour logger dans vos mods',
                'ðŸ› Testez avec un mod minimal pour isoler le problÃ¨me'
              ];
              break;
              
            default:
              suggestions = [
                'ðŸ“š Consultez la [documentation](Documentation/) du projet',
                'ðŸ” Recherchez dans les [issues existantes](../../issues)',
                'ðŸ’¬ DÃ©crivez votre environnement (OS, version du jeu, BepInEx)',
                'ðŸ“‹ Partagez les logs pertinents'
              ];
          }
          
          const responseBody = `## ðŸ¤– Assistant Mod Per Aspera
          
          J'ai dÃ©tectÃ© que votre problÃ¨me concerne : **${detectedType.replace('-', ' ')}**
          
          ### ðŸ’¡ Suggestions :
          ${suggestions.map(s => `- ${s}`).join('\n')}
          
          ### ðŸ“‹ Informations utiles Ã  fournir :
          - Version de Per Aspera
          - Version de BepInEx utilisÃ©e
          - SystÃ¨me d'exploitation
          - Logs d'erreur complets (\`BepInEx/LogOutput.log\`)
          - Fichiers de configuration modifiÃ©s
          
          ### ðŸ”— Ressources utiles :
          - [Documentation du projet](Documentation/)
          - [Exemples de mods](working/)
          - [Configuration BepInEx](Documentation/.roo/)
          - [GitHub Actions pour CI/CD](.github/workflows/)
          
          ---
          *Cet assistant automatique analyse votre problÃ¨me pour vous orienter. Pour une aide personnalisÃ©e, mentionnez \`@mod-assistant\` dans vos commentaires.*`;
          
          if (issue) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: responseBody
            });
            
            // Ajouter des labels appropriÃ©s
            const labels = ['mod-help', `type:${detectedType}`];
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labels
            });
          }