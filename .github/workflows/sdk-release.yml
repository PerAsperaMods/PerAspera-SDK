name: SDK Release Pipeline

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0-beta.1)'
        required: true
        type: string
      pre_release:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: true

env:
  DOTNET_VERSION: '6.0.x'
  GITHUB_ACTIONS: true  # Active le mode CI/CD

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore Stripped GameLibs from Cache
      id: cache-gamelibs
      uses: actions/cache@v4
      with:
        path: GameLibs-Stripped
        key: per-aspera-gamelibs-stripped-${{ runner.os }}-v1
        
    - name: Generate Stripped GameLibs with BepInEx.GameLibsMaker
      if: steps.cache-gamelibs.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        Write-Host "üîß Generating stripped GameLibs with BepInEx.GameLibsMaker..." -ForegroundColor Cyan
        
        # Download BepInEx.GameLibsMaker
        $downloadUrl = "https://github.com/EnoPM/BepInEx.GameLibsMaker/releases/latest/download/GameLibsMaker.exe"
        $toolPath = "tools/GameLibsMaker.exe"
        
        New-Item -Path "tools" -ItemType Directory -Force
        
        Write-Host "üì• Downloading BepInEx.GameLibsMaker..." -ForegroundColor Blue
        Invoke-WebRequest -Uri $downloadUrl -OutFile $toolPath
        
        # Create mock game structure for demonstration
        # In real scenario, this would use actual game DLLs from secure storage/artifacts
        Write-Host "üéÆ Setting up mock game structure for CI/CD demo..." -ForegroundColor Yellow
        $mockGamePath = "mock-game"
        New-Item -Path "$mockGamePath/Per Aspera_Data/Managed" -ItemType Directory -Force
        
        # Create minimal assembly for CI/CD compilation test
        $mockAssembly = @'
using System.Reflection;
[assembly: AssemblyVersion("1.0.0.0")]
namespace PerAspera { public class Game { } }
'@
        
        Set-Content "$mockGamePath/Per Aspera_Data/Managed/Assembly-CSharp.cs" $mockAssembly
        csc.exe /target:library /out:"$mockGamePath/Per Aspera_Data/Managed/Assembly-CSharp.dll" "$mockGamePath/Per Aspera_Data/Managed/Assembly-CSharp.cs"
        
        # Run GameLibsMaker
        Write-Host "üöÄ Running GameLibsMaker (Publicize + Strip)..." -ForegroundColor Green
        $configContent = @"
$mockGamePath
GameLibs-Stripped
"@
        Set-Content ".GameLibsMaker" $configContent
        
        & $toolPath
        
        Write-Host "‚úÖ Stripped GameLibs generated for CI/CD!" -ForegroundColor Green
        
    - name: Validate Stripped GameLibs
      shell: pwsh
      run: |
        Write-Host "üîç Validating stripped GameLibs for CI/CD..." -ForegroundColor Blue
        
        # Verify stripped GameLibs directory
        if (-not (Test-Path "GameLibs-Stripped")) {
            throw "GameLibs-Stripped directory not found!"
        }
        
        # Check for GameLibs.props
        $propsFile = "GameLibs-Stripped/GameLibs.props"
        if (Test-Path $propsFile) {
            Write-Host "‚úÖ GameLibs.props found" -ForegroundColor Green
        } else {
            Write-Warning "‚ö†Ô∏è GameLibs.props not found, generating basic version"
        }
        
        # List generated files
        $dlls = Get-ChildItem "GameLibs-Stripped" -Filter "*.dll"
        Write-Host "üì¶ Generated stripped DLLs: $($dlls.Count)" -ForegroundColor Cyan
        
        foreach ($dll in $dlls | Select-Object -First 5) {
            $size = [math]::Round($dll.Length / 1KB, 2)
            Write-Host "  - $($dll.Name) ($size KB)" -ForegroundColor Gray
        }
        
        Write-Host "üéØ Stripped GameLibs validation complete!" -ForegroundColor Green
        
    - name: Update Version
      shell: pwsh
      run: |
        $version = "${{ github.event.inputs.version }}"
        Write-Host "Setting version to: $version"
        .\Manage-Version.ps1 -Version $version
        
    - name: Restore dependencies
      run: dotnet restore PerAspera.SDK.sln
      
    - name: Build SDK
      run: dotnet build PerAspera.SDK.sln --configuration Release --no-restore
      
    - name: Test SDK
      run: dotnet test PerAspera.SDK.sln --configuration Release --no-build --verbosity normal
      
    - name: Pack NuGet packages
      run: dotnet pack PerAspera.SDK.sln --configuration Release --no-build --output ./packages
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: sdk-v${{ github.event.inputs.version }}
        release_name: SDK v${{ github.event.inputs.version }}
        body: |
          ## PerAspera SDK v${{ github.event.inputs.version }}
          
          ### Changes
          - Auto-generated release from CI/CD pipeline
          
          ### Installation
          ```bash
          dotnet add package PerAspera.Core --version ${{ github.event.inputs.version }}
          dotnet add package PerAspera.GameAPI --version ${{ github.event.inputs.version }}
          dotnet add package PerAspera.ModSDK --version ${{ github.event.inputs.version }}
          ```
          
          ### Documentation
          See [SDK Documentation](./Documentation/README.md) for details.
        draft: false
        prerelease: ${{ github.event.inputs.pre_release }}
        
    - name: Upload NuGet packages
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./packages
        asset_name: PerAspera-SDK-${{ github.event.inputs.version }}-packages.zip
        asset_content_type: application/zip
        
    - name: Publish to NuGet (if configured)
      if: env.NUGET_API_KEY != ''
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        dotnet nuget push "./packages/*.nupkg" --api-key ${{ env.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate